
# 公理设计文档 (ADD): “AI亲情画板”项目

| 文档版本 | 创建日期 | 关联文档 |
| :--- | :--- | :--- |
| v1.0 | 2025年9月3日 | `用户需求文档 (URD) v1.1` |

-----

## 1\. 文档引言

### 1.1 目的

本文档是“AI亲情画板”项目的公理设计文档（Axiomatic Design Document）。其核心目的在于将《用户需求文档 (URD) v1.1》中定义的功能需求（Functional Requirements - FRs）系统地映射到具体的设计参数（Design Parameters - DPs）上。

通过应用公理设计（Axiomatic Design）的两大基本公理——独立性公理和信息公理，我们旨在构建一个逻辑清晰、功能解耦、高内聚、低耦合的系统架构，从而保证项目的可开发性、可维护性和未来的可扩展性。

### 1.2 设计原则

  - **独立性公理 (The Independence Axiom):** 维持功能需求（FRs）的独立性。即一个设计参数（DP）的改变应只影响一个功能需求（FR），避免连锁反应。
  - **信息公理 (The Information Axiom):** 最小化设计的信息内容。即在满足独立性公理的前提下，选择最简洁、最直接、最可靠的设计方案。

-----

## 2\. 高层级设计分解 (Top-Level Decomposition)

为了实现项目的总体目标，我们将最高层级的功能需求（FR0）与设计参数（DP0）定义如下：

  - **FR0:** 提供一个安全的、支持多用户的、可进行对话式图片生成的Web应用服务。
  - **DP0:** 构建一个基于`Streamlit`框架的Web应用，该应用：
      - 使用 `streamlit-authenticator` 库进行用户认证与会话管理。
      - 通过 `secrets.toml` 配置文件安全地管理用户凭证和API密钥。
      - 利用 `st.session_state` 机制维护对话上下文。
      - 通过Python后端调用Google Nano Banana API的核心服务。

-----

## 3\. 功能需求 (FRs) 与设计参数 (DPs) 详细映射

我们将URD中的功能需求进行逻辑分组，并逐一映射到具体的设计参数上。

### 3.1 模块一：用户认证与会话管理

| 需求ID (URD) | 功能需求 (FR) | 设计参数 (DP) |
| :--- | :--- | :--- |
| `FR-001` | **FR1:** 验证用户身份。 | **DP1:** 采用 `streamlit-authenticator` 库，它提供标准的登录/登出UI组件和后台验证逻辑。 |
| `FR-002` | **FR2:** 安全地管理用户凭证。 | **DP2:** 在 `.streamlit/secrets.toml` 文件中存储用户信息。密码必须使用 `streamlit-authenticator` 提供的工具进行哈希加密后存入，确保明文密码不被存储。 |
| `FR-004` | **FR3:** 保持用户登录状态。 | **DP3:** 配置 `streamlit-authenticator` 的Cookie功能，设定一个合理的有效期（例如30天），以实现“记住我”的自动登录体验。 |

### 3.2 模块二：核心逻辑与AI集成

| 需求ID (URD) | 功能需求 (FR) | 设计参数 (DP) |
| :--- | :--- | :--- |
| `FR-003` | **FR4:** 安全地管理API密钥。 | **DP4:** 将Google API Key存储在 `.streamlit/secrets.toml` 文件中。在服务器端Python代码中，通过 `st.secrets["google_api_key"]` 的方式进行调用，确保密钥不暴露于前端。 |
| `FR-005`, `FR-006` | **FR5:** 实现有上下文的对话式图片生成。 | **DP5:** 使用Streamlit的 `st.session_state` 对象来创建一个列表（如 `st.session_state.messages`），用于存储和追溯完整的对话历史。 |
| `FR-011` | **FR6:** 管理对话上下文窗口。 | **DP6:** 在调用API之前，编写一个函数，该函数从 `secrets.toml` 读取管理员设定的窗口宽度（N），并从 `st.session_state.messages` 列表中仅截取最近的N条消息作为上下文发送给API。 |
| `NFR-004` | **FR7:** 提供可靠的API调用机制。 | **DP7:** 将API调用封装在一个带有错误处理（`try...except`）和重试逻辑的函数中。可使用如 `tenacity` 等库实现指数退避重试。若最终失败，则通过 `st.error()` 向用户展示预设的友好提示信息。 |

### 3.3 模块三：用户界面与交互 (UI/UX)

| 需求ID (URD) | 功能需求 (FR) | 设计参数 (DP) |
| :--- | :--- | :--- |
| `FR-008` | **FR8:** 清晰展示对话历史。 | **DP8:** 在UI上遍历 `st.session_state.messages` 列表，使用 `st.chat_message` 组件，根据消息的角色（用户或AI）来渲染对话气泡，实现类似聊天软件的界面。 |
| `FR-007` | **FR9:** 提供快捷指令。 | **DP9:** 使用 `st.button` 在输入框附近水平排列，形成快捷指令栏。按钮的点击事件将预设的文本填充到聊天输入框或直接触发一次新的API调用。 |
| `FR-010` | **FR10:** 实现图片下载功能。 | **DP10:** 当图片生成后，将其数据（如PIL Image对象）转换为字节流（bytes），然后使用 `st.download_button` 组件提供给用户进行一键下载。 |
| `FR-009` | **FR11:** 实现状态重置。 | **DP11:** 设置一个“重新开始”的 `st.button`。其回调函数负责清空 `st.session_state` 中的核心键（如 `messages` 和 `current_image`），并触发页面重新渲染，回到初始状态。 |

-----

## 4\. 公理分析

### 4.1 独立性公理分析

为了验证设计的解耦性，我们构建如下的设计矩阵（Design Matrix）。矩阵的行代表功能需求（FRs），列代表设计参数（DPs）。“X”表示DP直接用于实现FR。

| | DP1\<br\>(认证库) | DP2\<br\>(凭证配置) | DP3\<br\>(Cookie) | DP5\<br\>(会话状态) | DP6\<br\>(上下文切片) | DP7\<br\>(API调用) | DP8\<br\>(聊天UI) | ... |
| :--- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| **FR1 (认证)** | X | X | | | | | | |
| **FR2 (凭证管理)** | | X | | | | | | |
| **FR3 (会话保持)** | X | | X | | | | | |
| **FR5 (对话上下文)** | | | | X | | | | |
| **FR6 (窗口管理)** | | | | | X | | | |
| **FR7 (可靠调用)** | | | | | | X | | |
| **FR8 (历史UI)** | | | | X | | | X | |
| **...** | | | | | | | | |

**分析结论:**

  - 该矩阵近似为一个对角矩阵，展示了良好的解耦性。
  - 用户认证模块 (FR1, FR2, FR3) 与核心应用逻辑模块 (FR5, FR6, FR7) 之间没有直接耦合。
  - FR1（认证）同时依赖DP1和DP2，FR3（会话保持）依赖DP1和DP3，这是因为`streamlit-authenticator`库本身就是一个集成了UI、逻辑和Cookie管理的模块化解决方案，这种内部耦合是可接受的。
  - FR8（历史UI）依赖于DP5（会話狀態）的数据源和DP8（聊天UI）的渲染，这是一个标准的数据到视图的单向依赖，不违反独立性。
  - **总体而言，该设计满足独立性公理，修改任一设计参数，其影响范围都被有效控制在对应的功能需求内。**

### 4.2 信息公理分析

本项目的设计严格遵守信息公理，力求简洁高效。

  - **复用成熟方案:** 我们没有重新发明轮子，而是选用了 `Streamlit` 和 `streamlit-authenticator` 等社区广泛认可、文档齐全的库，极大地降低了开发的复杂性（即信息内容）。
  - **遵循平台惯例:** 设计参数（如 `st.secrets`, `st.session_state`, `st.download_button`）均是Streamlit框架的原生或惯用模式，这使得代码易于被其他熟悉Streamlit的开发者理解和维护。
  - **配置驱动:** 将可变部分（如用户凭证、API密钥、上下文窗口大小）全部移至配置文件中，使核心代码逻辑保持稳定和简洁。

此设计在所有满足功能需求的方案中，具有较低的信息内容。

-----

## 5\. 结论

本公理设计文档详细阐述了如何将“AI亲情画板”的用户需求转化为一套具体、解耦且简洁的设计方案。通过详细的FR-DP映射和公理分析，我们验证了当前设计架构的健壮性和合理性。

该设计方案为下一步的开发实施工作提供了清晰、可靠的蓝图。